name: Track Website Changes

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:
    inputs:
      subdirectory:
        description: 'Subdirectory to deploy to'
        required: false
        default: '/'
        type: string
  push:
    branches: [ main ]
    paths: [ 'watcher-config.toml' ]

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  track:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.tracker.outputs.deployment-url }}
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Track websites and deploy
        id: tracker
        uses: ./  # Use the action from this repo
        with:
          sites-config: watcher-config.toml
          subdirectory: ${{ github.event.inputs.subdirectory || '/' }}
          # Other available options we're using defaults for:
          # generate-site: true      # We want the static site
          # output-dir: deploy       # Standard deployment directory
          # base-url: ''             # Auto-detected from repo name
          # commit-to-gh-pages: true # Preserve history
          # deploy-to-pages: true    # Deploy to GitHub Pages
      
      - name: Summary
        run: |
          echo "### Tracking Results" >> $GITHUB_STEP_SUMMARY
          echo "- Updated: ${{ steps.tracker.outputs.updated-count }} sites" >> $GITHUB_STEP_SUMMARY
          echo "- Errors: ${{ steps.tracker.outputs.error-count }} sites" >> $GITHUB_STEP_SUMMARY
          echo "- [View Site](${{ steps.tracker.outputs.deployment-url }})" >> $GITHUB_STEP_SUMMARY
